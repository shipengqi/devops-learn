---
title: CPU
weight: 5
---

## 进程管理

- `ps`：拍一张静态照片，用于详细分析、查找和记录。
- `top`：打开实时直播，用于动态监控和即时操作。
- `pstree`：画一张家谱/关系图，用于理解进程间的依赖和层次关系。

### ps

查看进程状态快照。

- `ps aux`：(**最常用**) 显示**所有用户的所有进程**的详细信息。相比较 `ps -ef` 多了两列 `%CPU` 和 `%MEM`，少了一列 `PPID`。
- `ps -ef`：显示所有进程的完整格式信息。
- `ps -eF`：显示所有进程的更详细的完整格式信息。
- `ps -eo`：自定义输出列。
- `ps -eLf`：显示线程。

```bash
# 查找 nginx 或 java 进程
ps aux | grep nginx
ps aux | grep java

# 按 CPU 使用率降序排列
# sort 参数可能有些系统不支持，sort 命令功能更丰富
ps aux --sort=-%cpu | head -10

# 按内存使用率降序排列
ps aux --sort=-%mem | head -10

# 查看进程的父进程 ID （PPID）
ps -eo pid,ppid,cmd | grep <进程名>

# 检查僵尸进程
ps aux | awk '$8=="Z" {print $0}'
```

### pstree

以树状结构显示进程之间的父子关系。

- `-p`，`--pid` (最常用) 显示进程ID（PID）。	
- `-a`，`--arguments` 显示命令行参数。
- `-u`，`--user` 显示用户信息。
- `-H`，`--highlight` 高亮显示指定进程及其祖先。

使用场景：

1. 直观查看系统的进程层次结构。
2. 排查“杀不掉的进程” ：
   - 如果一个进程反复被拉起，用 pstree 可以清晰地看到它的父进程是谁，从而找到根源并处理父进程。
3. 分析由守护进程（如 systemd, supervisord）管理的服务查看服务的所有子进程是否正常启动。

### top

top 显示进程和系统信息。其实和 ps 差不多，只不过显示的是实时数据。它是交互式的。

常用交互指令:

- `P` (大写) 按 CPU 使用率排序；
- `M` (大写) 按 内存使用率（RES） 排序；
- `N` (大写) 按 PID 排序；
- `T` (大写) 按 CPU 时间（TIME+） 排序；
- `k` 终止一个进程（会提示输入PID）；
- `r` renice（修改进程优先级）；
- `1` 展开显示所有CPU核心的详细使用情况。

top 命令进程的几种状态：

- `R` 运行（正在运行或等待运行）；
- `S` 中断（睡眠）；
- `D` 不可中断（等待 IO）；
- `Z` 僵尸（已终止，但父进程未回收）；
- `T` 停止（已停止）；
- `N` 不可见（没有显示）。

### 三者的协同工作流

1. `top`：发现问题。发现系统负载很高，CPU `%wa`（等待 IO）指标飙升。
2. 在 `top` 中按 `M`：初步定位。发现没有进程占用特别高的内存或CPU。
3. `ps aux`：深入分析。结合 `grep` 和状态过滤，寻找处于 `D`（不可中断睡眠）状态的进程，这通常是导致高 IO 等待的根源：
   - `ps aux | awk '$8=="D" {print $0}'`， 查找 `D` 状态的进程。
4. `pstree -p`：追溯根源。如果找到问题进程，用 pstree 查看是谁启动了它，判断影响范围，决定是终止子进程还是父进程。
5. `kill -9 <PID>`：强制终止进程。如果终止后问题没有解决，可能需要重启系统。
6. `top`：再次检查。确认问题是否解决。
