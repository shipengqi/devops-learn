---
title: AWS
weight: 1
---

## AWS 全球基础设施

AWS 在全球有 27 个区域，区域是分散在世界各地**数据中心的物理位置**。**每个区域都有多个可用区（Availability Zone），每个可用区都是一个独立的、故障隔离的区域**。可用区是区域中的一个或多个数据中心。

例如区域：

- us-east-1
- eu-west-1
- ap-southeast-1

各个区域直接通过高速网络连接，延迟低。是 AWS 的骨干网。

## 可用区

可用区可以创建子网，可以是**公有子网**，也可以是**私有子网**。**每个子网始终都是在一个可用区内的**。

可用区一般是由多个数据中心组成的。冗余电源，网络等，保证高可用。

## VPC

VPC 是 Virtual Private Cloud 的缩写，**虚拟私有云**。是在 AWS 上的一个逻辑隔离的虚拟网络。

**在区域中可以创建多个 VPC**，一个区域最多 5 个 VPC。每个 **VPC 都是一个独立的网络环境**，**可以在 VPC 中创建子网、路由表、安全组等**。

每个**子网选择一个可用区**，一个**可用区可以创建多个子网**。

然后就可以将 EC2 实例部署到不同的子网中。

### VPC 路由器

VPC 路由器负责互联子网并在网关、NAT 网关等组件之间路由流量。

**路由表**是用来配置 VPC 路由器的。

### 网关

如果要访问外部网络，还需要通过网关。每个 VPC 只有一个网关。负责出口流量和接收进入 VPC 的流量（入口流量）。

### CIDR

- 每个 VPC 都需要配置一个 CIDR，例如 `10.0.0.0/16`。
- 每个子网都需要配置一个 CIDR，例如 `10.0.0.0/24`，`10.0.1.0/24`，`10.0.2.0/24`。
- 每个子网的 CIDR 必须在 VPC 的 CIDR 范围内。

### ACL

Network ACL 是子网的防火墙，默认拒绝所有流量。

### Security Group

Security Group 是 EC2 实例的防火墙，默认拒绝所有流量。

### 创建 VPC

- **创建 VPC 会默认创建一个路由表，路由表中会有一个默认路由，指向 Internet 网关**。
- **还会默认创建一个 Network ACL，Network ACL 是子网的防火墙，默认拒绝所有流量**。
- **还会默认创建一个 Security Group，Security Group 是 EC2 实例的防火墙，默认拒绝所有流量**。



### 为什么不建议使用 AWS 默认 VPC？

AWS 默认 VPC 是一个为了方便用户快速开始而设计的“入门级”网络环境。它牺牲了安全性、灵活性和最佳实践来换取便捷性。

- 第一是安全风险，它的所有子网默认都是公网的，且容易导致不同项目间缺乏网络隔离。
- 第二是设计僵化，它的 CIDR 块不可更改，极易导致与其他网络连接时发生 IP 冲突，也无法实现公私子网分离的最佳架构。1
- 第三是可扩展性差，它在多账户策略中会成为噩梦，因为所有账户的默认 VPC 网段都重叠。
- 第四是违背 IaC 原则，对于像 Terraform 这样的工具，依赖一个隐式的默认资源会使代码缺乏可移植性和明确性。

#### 应该怎么做？

1. 为每个工作负载创建自定义 VPC：根据应用的需求，精心设计 IP 地址空间（CIDR block），确保不会与任何需要连接的网络重叠（如公司局域网、其他 VPC）。

2. 设计分层子网：
   - **公有子网：路由指向 Internet Gateway**，用于放置面向公众的负载均衡器、NAT 网关、Bastion Host（跳板机）。
   - **私有子网：路由指向 NAT Gateway（用于出站互联网访问）或仅指向内部网关**，用于放置应用程序服务器、工作队列、缓存服务。
   - **隔离子网（或数据子网）：没有通往互联网的路由，用于放置数据库、数据存储等最敏感的后端服务**。

3. 配置安全组和网络 ACL：
   - 只开放必要的端口和协议。
   - 为每个子网创建自定义的 Security Group，限制入站和出站流量。
   - 配置 Network ACL 以控制子网内流量，例如拒绝来自外部的 ICMP 流量。

4. 启用 VPC 流日志（可选）：
   - 用于监控和分析 VPC 流量，帮助检测异常活动。

5. 监控和维护：
   - 定期审查和更新安全组和网络 ACL，确保只允许必要的流量。
   - 监控 VPC 流日志，及时发现和响应安全事件。